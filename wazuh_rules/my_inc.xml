<!-- нужно наполнить списки -->
<var name="hack_utils_win">nmap\.exe|zenmap\.exe</var>
<var name="hack_utils_unix">nmap|zenmap</var>
<var name="rat_utils_win">vnc</var>
<var name="rat_utils_unix">vnc</var>
<var name="recon_utils_win">ping|nslookup|tracert|net|whoami|systeminfo|tasklist|ipconfig|netstat|route</var>
<var name="recon_utils_unix">ping</var>
<var name="critical_registry">Run</var>
<var name="critical_win_path">windows</var>
<var name="critical_privileges">SeAssignPrimaryTokenPrivilege|SeTcbPrivilege|SeTakeOwnershipPrivilege|SeBackupPrivilege|SeRestorePrivilege|SeDebugPrivilege|SeImpersonatePrivilege|SeLoadDriverPrivilege|SeSecurityPrivilege|SeSystemEnvironmentPrivilege|SeManageVolumePrivilege|SeCreateTokenPrivilege|SeTrustedCredManAccessPrivilege</var>

<!-- STATISTIC GROUPS 100100 ids-->
<group name="recon_tools,">
  <!-- Sysmon -->
    <!-- Windows -->
    <rule id="100101" level="10">
      <if_sid>61603</if_sid>
      <field name="win.eventdata.originalFileName">$recon_utils_win</field>
      <description>Sysmon - Event 1: Process creation recon tool</description>
      <options>no_full_log</options>
    </rule>
    <!-- Unix -->
    <rule id="100102" level="10">
      <if_sid>67027</if_sid>
      <field name="НУЖНО ПОМЕНЯТЬ ПОЛЕ">$recon_utils_unix</field>
      <description>Hacktool UNIX decected: $(win.eventdata.newProcessName)</description>
      <options>no_full_log</options>
    </rule>
  <!-- Event log
  <rule id="100101" level="10">
    <if_sid>67027</if_sid>
    <field name="win.eventdata.newProcessName">$recon_utils_win</field>
    <description>Hacktool WINDOWS decected: $(win.eventdata.newProcessName)</description>
    <options>no_full_log</options>
  </rule>
  -->
  <!-- Auditd 
  <rule id="100102" level="10">
    <if_sid>67027</if_sid>
    <field name="НУЖНО ПОМЕНЯТЬ ПОЛЕ">$recon_utils_unix</field>
    <description>Hacktool UNIX decected: $(win.eventdata.newProcessName)</description>
    <options>no_full_log</options>
  </rule>
  -->
</group>

<!-- BRUTEFORCE -->
<group name="possible_bruteforce,">
<!-- Windows -->
  <!-- success - 60106 -->
  <!-- failed - 60122 -->
<!-- Unix -->
  <!-- success auth -->
  <!-- failed auth -->
</group>

<!-- STATIC GROUP 100300 ids-->
<group name="possible_incidents,">
  <!-- USER MANAGEMENT 100301 - 100325 -->
    <!-- lockout - ID 4740 -->
    <rule id="100301" level="15">
      <field name="win.system.eventID">^4740$</field>
      <list field="win.eventdata.targetUserName" lookup="match_key">etc/lists/critical_users</list>
      <description>Critical user is blocked.</description>
      <options>no_full_log</options>
    </rule>
    <!-- disable/delete crit user - ID 4725, 4726 (RULE 60111)-->
    <rule id="100302" level="15">
      <if_sid>60111</if_sid>
      <field name="win.system.eventID">^4725$</field>
      <list field="win.eventdata.targetUserName" lookup="match_key">etc/lists/critical_users</list>
      <description>Critical account was disabled.</description>
      <options>no_full_log</options>
      <group>adduser,account_changed,</group>
      <mitre>
        <id>T1098</id>
        <id>T1531</id>
      </mitre>
    </rule>
    <rule id="100303" level="15">
      <if_sid>60111</if_sid>
      <field name="win.system.eventID">^4726$</field>
      <list field="win.eventdata.targetUserName" lookup="match_key">etc/lists/critical_users</list>
      <description>Critical account was deleted.</description>
      <options>no_full_log</options>
      <group>adduser,account_changed,</group>
      <mitre>
        <id>T1098</id>
        <id>T1531</id>
      </mitre>
    </rule>
    <!-- passwd changed -->
    <rule id="100304" level="10">
      <field name="win.system.eventID">^4723$|^4724$</field>
      <list field="win.eventdata.targetUserName" lookup="match_key">etc/lists/critical_users</list>
      <description>Critical user password changed in WINDOWS.</description>
      <options>no_full_log</options>
      <mitre>
        <id>T1098</id>
        <id>T1531</id>
      </mitre>
    </rule>
    <!-- enabled/created user - ID 4720,4722 (RULE 60109) -->
    <!-- 100305, 100306-->
    <rule id="100305" level="8">
      <if_sid>60109</if_sid>
      <field name="win.system.eventID">^4720$</field>
      <description>User account enabled</description>
      <options>no_full_log</options>
      <group>adduser,account_changed,</group>
      <mitre>
        <id>T1098</id>
        <id>T1078</id>
        <id>T1136</id>
      </mitre>
    </rule>
    <rule id="100306" level="8">
      <if_sid>60109</if_sid>
      <field name="win.system.eventID">^4722$</field>
      <description>User account created</description>
      <options>no_full_log</options>
      <group>adduser,account_changed,</group>
      <mitre>
        <id>T1098</id>
        <id>T1078</id>
        <id>T1136</id>
      </mitre>
    </rule>
    <!-- UNIX 
    create user - 5902
    Jan 05 17:42:52 lubuntu useradd[21604]: new user: name=testuser, UID=1002, GID=1002, home=/home/testuser, shell=/bin/sh, from=/dev/pts/1
    Jan 05 17:48:36 lubuntu useradd[21691]: new user: name=test_svc, UID=995, GID=985, home=/home/test_svc, shell=/bin/false, from=/dev/pts/1
    -->
    <rule id="100311" level="10">
      <if_sid>5902</if_sid>
      <field name="uid" type="pcre2">^\d{1,3}$</field>
      <description>System service account created (UID < 1000).</description>
      <options>no_full_log</options>
      <group>adduser,account_changed,</group>
    </rule>
    <rule id="100312" level="15">
      <if_sid>100311</if_sid>
      <field name="uid" type="pcre2">^0$</field>
      <description>User created with UID=0 (ROOT equivalent).</description>
      <options>no_full_log</options>
      <group>adduser,account_changed,</group>
    </rule>
    <!-- delete user 
    5903 - userdel, srcuser
    Jan 06 09:56:51 lubuntu userdel[3488]: delete user 'test'
    -->
    <rule id="100313" level="15">
      <if_sid>5903</if_sid>
      <list field="user" lookup="match_key">etc/lists/critical_users</list>
      <description>Critical account was deleted.</description>
      <options>no_full_log</options>
      <group>adduser,account_changed,</group>
      <mitre>
        <id>T1098</id>
        <id>T1531</id>
      </mitre>
    </rule>
    <!-- passwd changed 
    Jan 05 17:44:25 lubuntu passwd[21643]: pam_unix(passwd:chauthtok): password changed for testuser
    -->
    <rule id="100314" level="10">
      <if_sid>5555</if_sid>
      <list field="user" lookup="match_key">etc/lists/critical_users</list>
      <description>Critical user password changed in UNIX.</description>
      <options>no_full_log</options>
      <mitre>
        <id>T1098</id>
        <id>T1531</id>
      </mitre>
    </rule>
  <!-- MALICIOUS TOOLS 100326 - 100350 -->
    <!-- HACK TOOLS -->
    <!-- SYSMON -->
    <rule id="100326" level="10">
      <if_sid>67027</if_sid>
      <field name="win.eventdata.newProcessName">$hack_utils_win</field>
      <description>Hacktool WINDOWS decected: $(win.eventdata.newProcessName)</description>
      <options>no_full_log</options>
    </rule>
    <rule id="100327" level="10">
      <if_sid>200151</if_sid>
      <field name="eventdata.image">$hack_utils_win</field>
      <description>Hacktool UNIX decected: $(win.eventdata.newProcessName)</description>
      <options>no_full_log</options>
    </rule>
    <!-- RAT TOOLS-->
    <rule id="100328" level="10">
      <if_sid>67027</if_sid>
      <field name="win.eventdata.newProcessName">$rat_utils_win</field>
      <description>RAT WINDOWS decected: $(win.eventdata.newProcessName)</description>
      <options>no_full_log</options>
    </rule>
    <rule id="100329" level="10">
      <if_sid>200151</if_sid>
      <field name="eventdata.image">$rat_utils_unix</field>
      <description>RAT UNIX decected: $(win.eventdata.newProcessName)</description>
      <options>no_full_log</options>
    </rule>
  <!-- PERSISTENCE 100351 - 100375 -->
    <!-- system service 
    sc create TestAuditSvc binPath= "C:\Windows\System32\calc.exe" start= demand DisplayName= "Тестовая служба для аудита"
    sc query TestAuditSvc
    sc start TestAuditSvc
    sc stop TestAuditSvc
    sc delete TestAuditSvc
    -->
    <rule id="100351" level="15"> 
      <if_sid>61138</if_sid> <!-- 7045 ID-->
      <field name="win.eventdata.imagePath">$critical_win_path</field>
      <description>New system service is installed.</description>
      <options>no_full_log</options>
    </rule>
    <!-- registry 13 id sysmon
    reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "TestWAZUH" /t REG_SZ /d "C:\Windows\System32\notepad.exe" /f
    reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "TestWAZUH"
    reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v "TestWAZUH" /f
    -->
    <rule id="100352" level="15">
      <if_sid>61615</if_sid>
      <field name="win.eventdata.targetObject">$critical_registry</field>
      <description>Critical regictry was modified.</description>
      <options>no_full_log</options>
    </rule>
    <!-- modification system files -->
    <!--
    <rule id="100124" level="15">
      <if_sid></if_sid>
      <field name=""></field>
      <description>System file was modified.</description>
      <options>no_full_log</options>
    </rule>
    -->
    <!-- new system driver -->
    <rule id="100353" level="15">
      <if_sid>100620</if_sid>
      <field name="rule_id">87704</field>
      <description>New system driver was installed.</description>
      <options>no_full_log</options>
    </rule>
  <!-- ADMIN ACTIVITY 100376 - 100400 -->
    <rule id="100376" level="12">
      <if_group>windows</if_group>
      <if_sid>60118</if_sid>
      <field name="win.eventdata.targetUserSid">.*-500$</field>
      <description>Windows: Login with built-in Administrator account (SID-500)</description>
    </rule>
    <!-- critical privs -->
    <rule id="100377" level="12">
      <if_sid>104672</if_sid>
      <field name="win.eventdata.privilegeList">$critical_privileges</field>
      <description>Windows: Critical privilege detected for $(win.eventdata.subjectUserName)</description>
      <options>no_full_log</options>
    </rule>
    <!-- sudo root or svc -->
    <rule id="100388" level="15">
      <if_sid>5501</if_sid>
      <user type="pcre2">uid=([1-9][0-9]{0,2})</user>
      <description>Sudo to SVC user.</description>
      <options>no_full_log</options>
    </rule>
    <rule id="100389" level="15">
      <if_sid>5501</if_sid>
      <user type="pcre2">uid=0</user>
      <description>Sudo to root.</description>
      <options>no_full_log</options>
    </rule>
  <!-- COVERING THE TRACKS -->
    <!-- clear logs -->
    <!-- example for test
    wevtutil cl "Windows PowerShell" - 104 event id - 63104
    wevtutil cl "Security" - 1102 event id - 63103
    -->
    <!-- stop auditd 80703 
    systemctl stop auditd-->
  <!-- NETWORK ACTIVITY -->
    <rule id="100401" level="7">
      <if_sid>87701</if_sid>
      <list field="dstport" lookup="match_key">etc/lists/malware_ports</list>
      <description>Traffic from EXTERNAL networks by ADMIN port</description>
      <group>possible_ioc,</group>
    </rule>
    <rule id="100402" level="7">
      <if_sid>87702</if_sid>
      <list field="srcport" lookup="match_key">etc/lists/malware_ports</list>
      <description>Traffic to EXTERNAL networks by ADMIN port</description>
      <group>possible_ioc,</group>
    </rule>
  <!-- IOC GROUP 100500 -->
  <!-- IP -->
    <rule id="100501" level="10">
      <if_group>possible_ioc</if_group>
      <list field="srcip" lookup="match_key">etc/lists/malware_ip</list>
      <description>Source IP IOC detected.</description>
      <options>no_full_log</options>
    </rule>
    <rule id="100502" level="10">
      <if_group>possible_ioc</if_group>
      <list field="dstip" lookup="match_key">etc/lists/malware_ip</list>
      <description>Destination IP IOC detected.</description>
      <options>no_full_log</options>
    </rule>
  <!-- DOMAIN DNS-RESOLVE -->
    <rule id="100526" level="10">
      <if_sid>500000</if_sid>
      <list field="url" lookup="match_key">etc/lists/misp_urlhaus_domains</list>
      <description>DNS-resolve IOC domain.</description>
      <options>no_full_log</options>
    </rule>
</group>

<!-- GLOBAL NETWORK EXCLUSIONS IF NEED -->
	<!--
	<rule id="87707" level="3">
		<if_sid>87703</if_sid>
		<list field="metainfo" lookup="match_key">etc/lists/excl_ip_pair</list>
		<description>Traffic from EXTERNAL networks by admin port in profile</description>
	</rule>
	
	<rule id="87708" level="3">
		<if_sid>87704</if_sid>
		<list field="metainfo" lookup="match_key">etc/lists/excl_ip_pair</list>
		<description>Traffic to EXTERNAL networks by admin port in profile</description>
	</rule>
	-->
	<!-- GLOBAL EXCLUSIONS BY SRC -->
	<!--
	<rule id="87709" level="3">
		<if_sid>87703,87704,87705,87706</if_sid>
		<list field="srcip" lookup="address_match_key">etc/lists/excl_ip_all</list>
		<description>Traffic by SRC in profile</description>
	</rule>
	
	<rule id="87710" level="3">
		<if_sid>87703,87704,87705,87706</if_sid>
		<list field="dstip" lookup="address_match_key">etc/lists/excl_ip_all</list>
		<description>Traffic by DST in profile</description>
	</rule>
->